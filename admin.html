<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - CodeMarket</title>
    <meta name="description" content="Admin panel for managing CodeMarket products and orders.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’»</text></svg>">
</head>
<body>
    <!-- Header -->
    <header>
        <nav class="container">
            <a href="/" class="logo">ðŸ’» CodeMarket Admin</a>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li id="logout-link" class="hidden"><a href="#" onclick="handleLogout()">Logout</a></li>
            </ul>
        </nav>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Login Form -->
        <section id="login-section" class="container">
            <div class="hero">
                <div class="card" style="max-width: 400px; margin: 2rem auto;">
                    <h2 class="text-center mb-3">Admin Login</h2>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" class="form-control" required>
                        </div>
                        <button type="submit" class="btn" style="width: 100%;" data-original-text="Login">
                            Login
                        </button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Admin Dashboard -->
        <section id="admin-dashboard" class="container hidden">
            <div class="admin-header">
                <h2 style="color: white; font-size: 2rem;">Product Management</h2>
                <div class="admin-actions">
                    <button id="add-product-btn" class="btn">Add New Product</button>
                </div>
            </div>

            <!-- Add/Edit Product Modal -->
            <div id="product-modal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                <div class="card" style="max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <div class="flex justify-between align-center mb-3">
                        <h3 id="modal-title">Add New Product</h3>
                        <button id="close-modal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    <form id="product-form">
                        <input type="hidden" id="product-id">
                        <div class="form-group">
                            <label for="product-title">Product Title</label>
                            <input type="text" id="product-title" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="product-description">Description</label>
                            <textarea id="product-description" class="form-control" rows="4" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="product-price">Price (â‚¹)</label>
                            <input type="number" id="product-price" class="form-control" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="product-image">Image URL</label>
                            <input type="url" id="product-image" class="form-control" placeholder="https://example.com/image.jpg">
                            <small style="color: #666; font-size: 0.9rem;">External image link (Google Drive, Imgur, etc.)</small>
                        </div>
                        <div class="form-group">
                            <label for="product-download">Download Link</label>
                            <input type="url" id="product-download" class="form-control" placeholder="https://drive.google.com/..." required>
                            <small style="color: #666; font-size: 0.9rem;">External download link (Google Drive, Dropbox, etc.)</small>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn" style="flex: 1;" data-original-text="Save Product">
                                Save Product
                            </button>
                            <button type="button" id="cancel-btn" class="btn btn-secondary" style="flex: 1;">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Products Table -->
            <div class="card">
                <div id="products-loading" class="text-center">
                    <div class="loading"></div>
                    <p style="margin-top: 1rem;">Loading products...</p>
                </div>
                
                <div id="products-content" class="hidden">
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Title</th>
                                <th>Price</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-tbody">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <div id="no-products" class="text-center hidden">
                    <p>No products found. <a href="#" onclick="showAddProductModal()">Add your first product</a></p>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>&copy; 2024 CodeMarket Admin Panel. All rights reserved.</p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script type="module">
        import { authService, productService, utils } from './js/firebase-config.js';

        // DOM elements
        const loginSection = document.getElementById('login-section');
        const adminDashboard = document.getElementById('admin-dashboard');
        const logoutLink = document.getElementById('logout-link');
        const loginForm = document.getElementById('login-form');
        const productModal = document.getElementById('product-modal');
        const productForm = document.getElementById('product-form');
        const productsLoading = document.getElementById('products-loading');
        const productsContent = document.getElementById('products-content');
        const noProducts = document.getElementById('no-products');
        const productsTbody = document.getElementById('products-tbody');

        // Global functions for onclick handlers
        window.handleLogout = handleLogout;
        window.showAddProductModal = showAddProductModal;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;

        // Check authentication state
        authService.onAuthStateChanged((user) => {
            if (user) {
                showAdminDashboard();
                loadProducts();
            } else {
                showLoginForm();
            }
        });

        // Login form handler
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            utils.setLoading(submitBtn, true);

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const result = await authService.signIn(email, password);
            
            if (result.success) {
                utils.showNotification('Login successful!', 'success');
            } else {
                utils.showNotification(result.error, 'error');
                utils.setLoading(submitBtn, false);
            }
        });

        // Product form handler
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            utils.setLoading(submitBtn, true);

            const productData = {
                title: document.getElementById('product-title').value,
                description: document.getElementById('product-description').value,
                price: parseFloat(document.getElementById('product-price').value),
                imageUrl: document.getElementById('product-image').value,
                downloadUrl: document.getElementById('product-download').value
            };

            const productId = document.getElementById('product-id').value;
            let result;

            if (productId) {
                result = await productService.updateProduct(productId, productData);
            } else {
                result = await productService.addProduct(productData);
            }

            if (result.success) {
                utils.showNotification(
                    productId ? 'Product updated successfully!' : 'Product added successfully!', 
                    'success'
                );
                hideProductModal();
                loadProducts();
            } else {
                utils.showNotification(result.error, 'error');
            }

            utils.setLoading(submitBtn, false);
        });

        // Modal event listeners
        document.getElementById('add-product-btn').addEventListener('click', showAddProductModal);
        document.getElementById('close-modal').addEventListener('click', hideProductModal);
        document.getElementById('cancel-btn').addEventListener('click', hideProductModal);

        // Close modal on outside click
        productModal.addEventListener('click', (e) => {
            if (e.target === productModal) {
                hideProductModal();
            }
        });

        // Functions
        function showLoginForm() {
            loginSection.classList.remove('hidden');
            adminDashboard.classList.add('hidden');
            logoutLink.classList.add('hidden');
        }

        function showAdminDashboard() {
            loginSection.classList.add('hidden');
            adminDashboard.classList.remove('hidden');
            logoutLink.classList.remove('hidden');
        }

        async function handleLogout() {
            const result = await authService.signOut();
            if (result.success) {
                utils.showNotification('Logged out successfully!', 'success');
            }
        }

        function showAddProductModal() {
            document.getElementById('modal-title').textContent = 'Add New Product';
            document.getElementById('product-id').value = '';
            productForm.reset();
            productModal.classList.remove('hidden');
        }

        function hideProductModal() {
            productModal.classList.add('hidden');
        }

        function editProduct(productId) {
            // Find product data
            const productRow = document.querySelector(`tr[data-product-id="${productId}"]`);
            if (!productRow) return;

            // Get product data from the row
            const cells = productRow.querySelectorAll('td');
            const title = cells[1].textContent;
            const price = cells[2].textContent.replace('â‚¹', '').replace(',', '');

            // Set modal title and form data
            document.getElementById('modal-title').textContent = 'Edit Product';
            document.getElementById('product-id').value = productId;
            document.getElementById('product-title').value = title;
            document.getElementById('product-price').value = price;

            // Load full product data
            productService.getProduct(productId).then(result => {
                if (result.success) {
                    const product = result.product;
                    document.getElementById('product-description').value = product.description || '';
                    document.getElementById('product-image').value = product.imageUrl || '';
                    document.getElementById('product-download').value = product.downloadUrl || '';
                }
            });

            productModal.classList.remove('hidden');
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;

            const result = await productService.deleteProduct(productId);
            if (result.success) {
                utils.showNotification('Product deleted successfully!', 'success');
                loadProducts();
            } else {
                utils.showNotification(result.error, 'error');
            }
        }

        async function loadProducts() {
            productsLoading.classList.remove('hidden');
            productsContent.classList.add('hidden');
            noProducts.classList.add('hidden');

            const result = await productService.getProducts();
            productsLoading.classList.add('hidden');

            if (result.success) {
                if (result.products.length === 0) {
                    noProducts.classList.remove('hidden');
                } else {
                    displayProducts(result.products);
                    productsContent.classList.remove('hidden');
                }
            } else {
                utils.showNotification(result.error, 'error');
                noProducts.classList.remove('hidden');
            }
        }

        function displayProducts(products) {
            productsTbody.innerHTML = '';

            products.forEach(product => {
                const row = document.createElement('tr');
                row.setAttribute('data-product-id', product.id);
                
                row.innerHTML = `
                    <td>
                        <img src="${product.imageUrl || 'https://via.placeholder.com/50x50?text=No+Image'}" 
                             alt="${product.title}"
                             onerror="this.src='https://via.placeholder.com/50x50?text=No+Image'">
                    </td>
                    <td>${product.title}</td>
                    <td>â‚¹${product.price.toLocaleString('en-IN')}</td>
                    <td>${utils.formatDate(product.createdAt)}</td>
                    <td>
                        <button onclick="editProduct('${product.id}')" class="btn btn-secondary" style="padding: 5px 10px; margin-right: 5px;">
                            Edit
                        </button>
                        <button onclick="deleteProduct('${product.id}')" class="btn btn-danger" style="padding: 5px 10px;">
                            Delete
                        </button>
                    </td>
                `;
                
                productsTbody.appendChild(row);
            });
        }
    </script>
</body>
</html>

